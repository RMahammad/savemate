generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mongodb"
    url      = env("DATABASE_URL")
}

enum Role {
    ADMIN
    USER
    BUSINESS
}

enum DealStatus {
    DRAFT
    PENDING
    APPROVED
    REJECTED
    EXPIRED
}

model User {
    id           String @id @default(auto()) @map("_id") @db.ObjectId
    email        String @unique
    passwordHash String
    role         Role   @default(USER)

    businessProfile BusinessProfile?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    favorites Favorite[]
    reports   Report[]
    auditLogs AuditLog[]
}

model BusinessProfile {
    id     String @id @default(auto()) @map("_id") @db.ObjectId
    userId String @unique @db.ObjectId
    user   User   @relation(fields: [userId], references: [id])

    name        String
    nip         String?
    city        String?
    voivodeship String?

    deals     Deal[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Category {
    id   String @id @default(auto()) @map("_id") @db.ObjectId
    name String @unique
    slug String @unique

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    deals Deal[]
}

model Deal {
    id         String          @id @default(auto()) @map("_id") @db.ObjectId
    businessId String          @db.ObjectId
    business   BusinessProfile @relation(fields: [businessId], references: [id])

    categoryId String   @db.ObjectId
    category   Category @relation(fields: [categoryId], references: [id])

    title           String
    description     String
    price           Float
    originalPrice   Float
    discountPercent Int

    status DealStatus @default(DRAFT)

    city        String
    voivodeship String
    tags        String[]

    validFrom DateTime
    validTo   DateTime

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    favorites Favorite[]
    reports   Report[]

    @@index([status, createdAt])
    @@index([categoryId, city])
}

model Favorite {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    userId    String   @db.ObjectId
    dealId    String   @db.ObjectId
    user      User     @relation(fields: [userId], references: [id])
    deal      Deal     @relation(fields: [dealId], references: [id])
    createdAt DateTime @default(now())

    @@unique([userId, dealId])
}

model Report {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    userId    String   @db.ObjectId
    dealId    String   @db.ObjectId
    reason    String
    details   String?
    user      User     @relation(fields: [userId], references: [id])
    deal      Deal     @relation(fields: [dealId], references: [id])
    createdAt DateTime @default(now())

    @@index([dealId, createdAt])
}

model AuditLog {
    id      String @id @default(auto()) @map("_id") @db.ObjectId
    actorId String @db.ObjectId
    actor   User   @relation(fields: [actorId], references: [id])

    action    String
    entity    String
    entityId  String
    meta      Json?
    createdAt DateTime @default(now())

    @@index([actorId, createdAt])
}
