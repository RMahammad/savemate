name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ci:
    runs-on: self-hosted
    # IMPORTANT for self-hosted runners:
    # don't run untrusted fork PRs on your machine.
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}

    env:
      # Backend
      PORT: ${{ secrets.PORT }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      JWT_ACCESS_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}
      JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
      ACCESS_TOKEN_TTL_MIN: ${{ secrets.ACCESS_TOKEN_TTL_MIN }}
      REFRESH_TOKEN_TTL_DAYS: ${{ secrets.REFRESH_TOKEN_TTL_DAYS }}
      CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}

      # Frontend (Vite only exposes vars prefixed with VITE_*)
      VITE_API_URL: ${{ secrets.VITE_API_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Prisma generate (backend)
        run: pnpm -C apps/backend exec prisma generate

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Build frontend
        run: pnpm -C apps/frontend build

      - name: Contract sync (OpenAPI) is committed
        run: |
          pnpm contract:sync
          git diff --exit-code

  deploy:
    name: Deploy on server (PM2)
    needs: ci
    runs-on: self-hosted
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    env:
      PORT: ${{ secrets.PORT }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      JWT_ACCESS_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}
      JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
      ACCESS_TOKEN_TTL_MIN: ${{ secrets.ACCESS_TOKEN_TTL_MIN }}
      REFRESH_TOKEN_TTL_DAYS: ${{ secrets.REFRESH_TOKEN_TTL_DAYS }}
      CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}
      UPLOADS_DIR: ${{ secrets.UPLOADS_DIR }}
      VITE_API_URL: ${{ secrets.VITE_API_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy and restart PM2
        shell: bash
        run: |
          set -euo pipefail

          # GitHub Actions can override HOME during a job.
          # PM2 stores its process list under $PM2_HOME (defaults to $HOME/.pm2).
          # Force a stable location so `pm2 list` matches your SSH session.
          USER_HOME="$(getent passwd "$(whoami)" | cut -d: -f6)"
          export HOME="$USER_HOME"
          export PM2_HOME="$USER_HOME/.pm2"
          mkdir -p "$PM2_HOME"

          if ! command -v pm2 >/dev/null 2>&1; then
            echo "pm2 is not installed on this self-hosted runner. Install it on the server:"
            echo "  sudo npm i -g pm2"
            exit 1
          fi

          # Deploy in-place from the checked-out workspace.
          # This keeps the workflow simple (no separate /opt clone required).
          APP_DIR="$GITHUB_WORKSPACE"
          cd "$APP_DIR"

          echo "[1/4] Write .env (from secrets)"
          node - <<'NODE'
          const fs = require('node:fs');
          const path = require('node:path');

          const envPath = path.join(process.cwd(), '.env');

          const required = [
            'PORT',
            'DATABASE_URL',
            'JWT_ACCESS_SECRET',
            'JWT_REFRESH_SECRET',
            'ACCESS_TOKEN_TTL_MIN',
            'REFRESH_TOKEN_TTL_DAYS',
            'CORS_ORIGIN',
            'UPLOADS_DIR',
            'VITE_API_URL',
          ];

          function normalizeSecretValue(key, value) {
            let v = String(value ?? '').trim();

            // If someone pasted a JSON-stringified value into Secrets (e.g. "mongodb+srv://..."),
            // try to decode it once so Prisma sees a clean mongo URL.
            if (v.startsWith('"') && v.endsWith('"')) {
              try {
                v = JSON.parse(v);
              } catch {
                // fall through
              }
            }

            // Strip surrounding quotes (common when users copy from .env examples)
            if (
              (v.startsWith('"') && v.endsWith('"')) ||
              (v.startsWith("'") && v.endsWith("'"))
            ) {
              v = v.slice(1, -1);
            }

            // Avoid raw newlines in .env
            v = v.replace(/\r?\n/g, '\\n');

            if (!v) {
              throw new Error(`Missing env ${key} (set it as a GitHub Secret)`);
            }
            return v;
          }

          function formatEnvLine(key, value) {
            // Keep it readable and Prisma-safe: write unquoted unless needed.
            // Quote if it contains spaces, #, or quotes.
            const needsQuotes = /\s|#|"/.test(value);
            if (!needsQuotes) return `${key}=${value}`;
            const escaped = value.replace(/"/g, '\\"');
            return `${key}="${escaped}"`;
          }

          const lines = [];
          for (const key of required) {
            const raw = process.env[key];
            const normalized = normalizeSecretValue(key, raw);
            lines.push(formatEnvLine(key, normalized));
          }

          fs.writeFileSync(envPath, lines.join('\n') + '\n', { mode: 0o600 });
          NODE

          echo "[2/4] Install deps"
          corepack enable >/dev/null 2>&1 || true
          pnpm install --frozen-lockfile

          echo "[3/4] Build"
          pnpm -C apps/backend exec prisma generate
          pnpm -C apps/frontend build

          echo "[3.5/4] Publish frontend to /var/www/savemate"
          if [ ! -d "apps/frontend/dist" ]; then
            echo "Expected apps/frontend/dist to exist after build"
            exit 1
          fi

          WEB_ROOT="/var/www/savemate"
          if [ ! -d "$WEB_ROOT" ] || [ ! -w "$WEB_ROOT" ]; then
            echo "Frontend publish directory is missing or not writable: $WEB_ROOT"
            echo "Run this ONCE on the server (interactive SSH) to allow the runner user to deploy without sudo:"
            echo "  sudo mkdir -p $WEB_ROOT"
            echo "  sudo chown -R $(whoami):www-data $WEB_ROOT"
            echo "  sudo chmod 2775 $WEB_ROOT"
            echo "  sudo find $WEB_ROOT -type d -exec chmod 2775 {} +"
            echo "  sudo find $WEB_ROOT -type f -exec chmod 664 {} +"
            exit 1
          fi

          # Use a non-root safe rsync: don't try to preserve owner/group from the source.
          # Ensure nginx-readable permissions on the deployed files.
          rsync -r --delete --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r "apps/frontend/dist/" "$WEB_ROOT/"

          echo "[4/4] PM2 start/reload"
          pm2 startOrReload ecosystem.config.cjs --only savemate-backend --update-env
          pm2 save
